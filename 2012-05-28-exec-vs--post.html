<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>2012-05-28: exec and Tail-call Optimization</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="racket.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--><link href="atom.xml" rel="alternate" title="Jay McCarthy" type="application/atom+xml"/><script type="text/javascript">var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30131476-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();</script></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Jay Mc<span class="mywbr"> &nbsp;</span>Carthy</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right"></td><td><a href="cat-categories.html" class="tocviewlink" data-pltdoc="x">Categories</a></td></tr><tr><td align="right"></td><td><a href="archive.html" class="tocviewselflink" data-pltdoc="x">Archive</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;">&bull;</td><td></td><td><a href="archive.html" class="tocviewlink" data-pltdoc="x">Archive</a></td></tr></table></div></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;<span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="2012-05-22-lz78-post.html" title="backward to &quot;2012-05-22: An LZ78 Implementation&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="archive.html" title="up to &quot;Archive&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="2012-06-05-word-cou-post.html" title="forward to &quot;2012-06-05: LaTeX and Word Counts&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h4><a name="(part._post)"></a>2012-05-28: exec and Tail-call Optimization</h4><div class="SAuthorListBox"><span class="SAuthorList"><p class="author"><a href="index.html" data-pltdoc="x">Jay McCarthy</a></p></span></div><p><div class="SIntrapara"></div><div class="SIntrapara"><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>The source for this post is online at <a href="https://github.com/jeapostrophe/jeapostrophe.github.com/tree/source/posts/2012-05-28-exec-vs-system.scrbl">2012-05-28-exec-vs-system.scrbl</a>.</p></blockquote></blockquote></blockquote></div><div class="SIntrapara"><span style="font-weight: bold">Categories:</span> <a href="cat-categories.html#%28part._.Systems%29" data-pltdoc="x">Systems</a> </div></p><p>I&rsquo;m often bothered by programs that fail to use <span class="stt">exec</span> properly and
instead use <span class="stt">system</span>. In this article, we&rsquo;ll review the difference
and relate it to tail-call optimization.</p><blockquote class="SCentered"><p>-</p></blockquote><p>In Unix, there&rsquo;s not really a way to start a totally new
process. Instead, every process comes into being by another process
duplicating itself with fork(). The two processes are identical at
that point, except that the fork() call returns 0 to the child and the
child&rsquo;s PID to the parent. Using this information, the two can behave
differently.</p><p>Often, what the child will do is change the program entirely by
loading a system binary and executing its main function. That task is
taken care of by the exec function, which receives the path to the
binary, plus the arguments, and, optionally, the environment.</p><p>Most programming languages give you access to a function named exec
which is a wrapper for this functionality. Its also likely that they
will also give a function named system that behaves almost the
same. It&rsquo;s main difference is that it returns the exit code of the
program when it exits and it invokes the shell to parse the
command-line arguments and look up the binary&rsquo;s full path.</p><p>If your program calls system in tail-position, meaning that the
program does nothing with the exit code nor does anything else after
ward, then you are wasting memory. In particular, the memory of the
parent process which has nothing to do. You should have just exec&rsquo;d,
not forked and then exec&rsquo;d.</p><p>Here&rsquo;s an example:</p><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"bad.sh"</span></span></p><blockquote class="Rfilecontent"><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">#!/bin/bash</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">x=${1:-10}</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">if [ $x -eq 0 ] ; then</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">read</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">echo done</span></p></td></tr><tr><td><p><span class="stt">else</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">./bad.sh $(expr $x - 1)</span></p></td></tr><tr><td><p><span class="stt">fi</span></p></td></tr></table></blockquote></blockquote><p>The process tree for this bad code looks like this:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">/bin/zsh</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">\_ bash bad.sh</span></p></td></tr><tr><td><p><span class="stt">|</span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">\_ bash bad.sh 9</span></p></td></tr><tr><td><p><span class="stt">|</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">\_ bash bad.sh 8</span></p></td></tr><tr><td><p><span class="stt">|</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">\_ bash bad.sh 7</span></p></td></tr><tr><td><p><span class="stt">|</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">\_ bash bad.sh 6</span></p></td></tr><tr><td><p><span class="stt">|</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">\_ bash bad.sh 5</span></p></td></tr><tr><td><p><span class="stt">|</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">\_ bash bad.sh 4</span></p></td></tr><tr><td><p><span class="stt">|</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">\_ bash bad.sh 3</span></p></td></tr><tr><td><p><span class="stt">|</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">\_ bash bad.sh 2</span></p></td></tr><tr><td><p><span class="stt">|</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">\_ bash bad.sh 1</span></p></td></tr><tr><td><p><span class="stt">|</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">\_ bash bad.sh 0</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">\_ ps f</span></p></td></tr></table></p><p>Compared to:</p><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"good.sh"</span></span></p><blockquote class="Rfilecontent"><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">#!/bin/bash</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">x=${1:-10}</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">if [ $x -eq 0 ] ; then</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">read</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">echo done</span></p></td></tr><tr><td><p><span class="stt">else</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">exec ./good.sh $(expr $x - 1)</span></p></td></tr><tr><td><p><span class="stt">fi</span></p></td></tr></table></blockquote></blockquote><p>(Notice that line 9 is different&#8212;<wbr></wbr>we&rsquo;ve explicitly used exec.)</p><p>This good code has a process tree like:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">/bin/zsh</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">\_ bash good.sh 0</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">\_ ps f</span></p></td></tr></table></p><p>This is very similar to the concept of safe-for-space, or tail-call
optimization, in programming languages. As you can see, unfortunately
bash is not safe-for-space by default. That is, it doesn&rsquo;t keep track
of when a call is in tail-position and automatically use exec rather
than system.</p><p>It&rsquo;s not just a problem with bash either, I&rsquo;ve never known any shell
that can run this program correctly.</p><p>In most cases, this is not problematic because the stack is unlikely
to grow very large and the executed program is unlikely to run for a
long time. However, it most often shows up as a problem with X11
window managers and menu programs.</p><p>Your Xsession initialization should always exec your window manager,
because there&rsquo;s nothing else it needs to do afterward.</p><p>An X11 menu program should also use exec to run the program, otherwise
whenever you start, for example Emacs, the shell that started it will
persist for the entire time you are running Emacs (presumably the
entire time you are at the computer.) In addition, you should exec
your menu program so that the shell that starts it is replaced as
well.</p><p>For example, the default Xmonad configuration does not do this
correctly and will invoke dmenu without an exec, leaving around the
shell forever. (dmenu is programmed correctly, though.)</p><p>So, raise your right arm and say with me: "I will always exec in
tail-position!"</p><p><div id="disqus_thread"><script type="text/javascript">
var disqus_shortname = 'jaymccarthy';
var disqus_identifier = 'http://jeapostrophe.github.com/blog/2012/05/28/exec-vs-system/';
var disqus_url = 'http://jeapostrophe.github.com/2012-05-28-exec-vs--post.html';
var disqus_script = 'embed.js';
(function () {
var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());

</script><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;<span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="2012-05-22-lz78-post.html" title="backward to &quot;2012-05-22: An LZ78 Implementation&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="archive.html" title="up to &quot;Archive&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="2012-06-05-word-cou-post.html" title="forward to &quot;2012-06-05: LaTeX and Word Counts&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>